\hypertarget{calibrate_8hpp_source}{}\doxysection{calibrate.\+hpp}
\label{calibrate_8hpp_source}\index{optimize/calibrate.hpp@{optimize/calibrate.hpp}}
\mbox{\hyperlink{calibrate_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// Copyright (c) Stanford University, The Regents of the University of}}
\DoxyCodeLine{2 \textcolor{comment}{//               California, and others.}}
\DoxyCodeLine{3 \textcolor{comment}{//}}
\DoxyCodeLine{4 \textcolor{comment}{// All Rights Reserved.}}
\DoxyCodeLine{5 \textcolor{comment}{//}}
\DoxyCodeLine{6 \textcolor{comment}{// See Copyright-\/SimVascular.txt for additional details.}}
\DoxyCodeLine{7 \textcolor{comment}{//}}
\DoxyCodeLine{8 \textcolor{comment}{// Permission is hereby granted, free of charge, to any person obtaining}}
\DoxyCodeLine{9 \textcolor{comment}{// a copy of this software and associated documentation files (the}}
\DoxyCodeLine{10 \textcolor{comment}{// "{}Software"{}), to deal in the Software without restriction, including}}
\DoxyCodeLine{11 \textcolor{comment}{// without limitation the rights to use, copy, modify, merge, publish,}}
\DoxyCodeLine{12 \textcolor{comment}{// distribute, sublicense, and/or sell copies of the Software, and to}}
\DoxyCodeLine{13 \textcolor{comment}{// permit persons to whom the Software is furnished to do so, subject}}
\DoxyCodeLine{14 \textcolor{comment}{// to the following conditions:}}
\DoxyCodeLine{15 \textcolor{comment}{//}}
\DoxyCodeLine{16 \textcolor{comment}{// The above copyright notice and this permission notice shall be included}}
\DoxyCodeLine{17 \textcolor{comment}{// in all copies or substantial portions of the Software.}}
\DoxyCodeLine{18 \textcolor{comment}{//}}
\DoxyCodeLine{19 \textcolor{comment}{// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "{}AS}}
\DoxyCodeLine{20 \textcolor{comment}{// IS"{} AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED}}
\DoxyCodeLine{21 \textcolor{comment}{// TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A}}
\DoxyCodeLine{22 \textcolor{comment}{// PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER}}
\DoxyCodeLine{23 \textcolor{comment}{// OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,}}
\DoxyCodeLine{24 \textcolor{comment}{// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,}}
\DoxyCodeLine{25 \textcolor{comment}{// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR}}
\DoxyCodeLine{26 \textcolor{comment}{// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF}}
\DoxyCodeLine{27 \textcolor{comment}{// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING}}
\DoxyCodeLine{28 \textcolor{comment}{// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS}}
\DoxyCodeLine{29 \textcolor{comment}{// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.}\textcolor{comment}{}}
\DoxyCodeLine{30 \textcolor{comment}{/**}}
\DoxyCodeLine{31 \textcolor{comment}{ * @file calibrate.hpp}}
\DoxyCodeLine{32 \textcolor{comment}{ * @brief OPT::calibrate source file}}
\DoxyCodeLine{33 \textcolor{comment}{ */}}
\DoxyCodeLine{34 \textcolor{preprocessor}{\#ifndef SVZERODSOLVER\_OPTIMIZE\_CALIBRATOR\_HPP\_}}
\DoxyCodeLine{35 \textcolor{preprocessor}{\#define SVZERODSOLVER\_OPTIMIZE\_CALIBRATOR\_HPP\_}}
\DoxyCodeLine{36 }
\DoxyCodeLine{37 \textcolor{preprocessor}{\#include <Eigen/Dense>}}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#include <Eigen/Sparse>}}
\DoxyCodeLine{39 \textcolor{preprocessor}{\#include <fstream>}}
\DoxyCodeLine{40 \textcolor{preprocessor}{\#include <nlohmann/json.hpp>}}
\DoxyCodeLine{41 }
\DoxyCodeLine{42 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{debug_8hpp}{helpers/debug.hpp}}"{}}}
\DoxyCodeLine{43 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{endswith_8hpp}{helpers/endswith.hpp}}"{}}}
\DoxyCodeLine{44 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{levenbergmarquardtoptimizer_8hpp}{levenbergmarquardtoptimizer.hpp}}"{}}}
\DoxyCodeLine{45 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{model_8hpp}{model/model.hpp}}"{}}}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespace_o_p_t}{OPT}} \{}
\DoxyCodeLine{48 }
\DoxyCodeLine{49 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{50 nlohmann::json calibrate(\textcolor{keyword}{const} nlohmann::json \&config) \{}
\DoxyCodeLine{51   \textcolor{keyword}{auto} output\_config = nlohmann::json(config);}
\DoxyCodeLine{52 }
\DoxyCodeLine{53   \textcolor{comment}{// Read calibration parameters}}
\DoxyCodeLine{54   DEBUG\_MSG(\textcolor{stringliteral}{"{}Parse calibration parameters"{}});}
\DoxyCodeLine{55   \textcolor{keyword}{auto} \textcolor{keyword}{const} \&calibration\_parameters = config[\textcolor{stringliteral}{"{}calibration\_parameters"{}}];}
\DoxyCodeLine{56   T gradient\_tol = calibration\_parameters.value(\textcolor{stringliteral}{"{}tolerance\_gradient"{}}, 1e-\/5);}
\DoxyCodeLine{57   T increment\_tol = calibration\_parameters.value(\textcolor{stringliteral}{"{}tolerance\_increment"{}}, 1e-\/10);}
\DoxyCodeLine{58   \textcolor{keywordtype}{int} max\_iter = calibration\_parameters.value(\textcolor{stringliteral}{"{}maximum\_iterations"{}}, 100);}
\DoxyCodeLine{59   \textcolor{keywordtype}{bool} calibrate\_stenosis =}
\DoxyCodeLine{60       calibration\_parameters.value(\textcolor{stringliteral}{"{}calibrate\_stenosis\_coefficient"{}}, \textcolor{keyword}{true});}
\DoxyCodeLine{61   \textcolor{keywordtype}{bool} zero\_capacitance =}
\DoxyCodeLine{62       calibration\_parameters.value(\textcolor{stringliteral}{"{}set\_capacitance\_to\_zero"{}}, \textcolor{keyword}{false});}
\DoxyCodeLine{63   T lambda0 = calibration\_parameters.value(\textcolor{stringliteral}{"{}initial\_damping\_factor"{}}, 1.0);}
\DoxyCodeLine{64 }
\DoxyCodeLine{65   \textcolor{keywordtype}{int} num\_params = 3;}
\DoxyCodeLine{66   \textcolor{keywordflow}{if} (calibrate\_stenosis) \{}
\DoxyCodeLine{67     num\_params = 4;}
\DoxyCodeLine{68   \}}
\DoxyCodeLine{69 }
\DoxyCodeLine{70   \textcolor{comment}{// Setup model}}
\DoxyCodeLine{71   \textcolor{keyword}{auto} model = \mbox{\hyperlink{class_m_o_d_e_l_1_1_model}{MODEL::Model<T>}}();}
\DoxyCodeLine{72   std::vector<std::tuple<std::string, std::string>> connections;}
\DoxyCodeLine{73   std::vector<std::tuple<std::string, std::string>> inlet\_connections;}
\DoxyCodeLine{74   std::vector<std::tuple<std::string, std::string>> outlet\_connections;}
\DoxyCodeLine{75 }
\DoxyCodeLine{76   \textcolor{comment}{// Create vessels}}
\DoxyCodeLine{77   DEBUG\_MSG(\textcolor{stringliteral}{"{}Load vessels"{}});}
\DoxyCodeLine{78   std::map<std::int64\_t, std::string> vessel\_id\_map;}
\DoxyCodeLine{79   \textcolor{keywordtype}{int} param\_counter = 0;}
\DoxyCodeLine{80   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \textcolor{keyword}{const} \&vessel\_config : config[\textcolor{stringliteral}{"{}vessels"{}}]) \{}
\DoxyCodeLine{81     std::string vessel\_name = vessel\_config[\textcolor{stringliteral}{"{}vessel\_name"{}}];}
\DoxyCodeLine{82 }
\DoxyCodeLine{83     \textcolor{comment}{// Create parameter IDs}}
\DoxyCodeLine{84     std::vector<int> param\_ids;}
\DoxyCodeLine{85     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} k = 0; k < num\_params; k++)}
\DoxyCodeLine{86       param\_ids.push\_back(param\_counter++);}
\DoxyCodeLine{87     model.add\_block(MODEL::BlockType::BLOODVESSEL, param\_ids, vessel\_name);}
\DoxyCodeLine{88     vessel\_id\_map.insert(\{vessel\_config[\textcolor{stringliteral}{"{}vessel\_id"{}}], vessel\_name\});}
\DoxyCodeLine{89     DEBUG\_MSG(\textcolor{stringliteral}{"{}Created vessel "{}} << vessel\_name);}
\DoxyCodeLine{90 }
\DoxyCodeLine{91     \textcolor{comment}{// Read connected boundary conditions}}
\DoxyCodeLine{92     \textcolor{keywordflow}{if} (vessel\_config.contains(\textcolor{stringliteral}{"{}boundary\_conditions"{}})) \{}
\DoxyCodeLine{93       \textcolor{keyword}{auto} \textcolor{keyword}{const} \&vessel\_bc\_config = vessel\_config[\textcolor{stringliteral}{"{}boundary\_conditions"{}}];}
\DoxyCodeLine{94       \textcolor{keywordflow}{if} (vessel\_bc\_config.contains(\textcolor{stringliteral}{"{}inlet"{}})) \{}
\DoxyCodeLine{95         inlet\_connections.push\_back(\{vessel\_bc\_config[\textcolor{stringliteral}{"{}inlet"{}}], vessel\_name\});}
\DoxyCodeLine{96       \}}
\DoxyCodeLine{97       \textcolor{keywordflow}{if} (vessel\_bc\_config.contains(\textcolor{stringliteral}{"{}outlet"{}})) \{}
\DoxyCodeLine{98         outlet\_connections.push\_back(\{vessel\_name, vessel\_bc\_config[\textcolor{stringliteral}{"{}outlet"{}}]\});}
\DoxyCodeLine{99       \}}
\DoxyCodeLine{100     \}}
\DoxyCodeLine{101   \}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103   \textcolor{comment}{// Create junctions}}
\DoxyCodeLine{104   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \textcolor{keyword}{const} \&junction\_config : config[\textcolor{stringliteral}{"{}junctions"{}}]) \{}
\DoxyCodeLine{105     std::string junction\_name = junction\_config[\textcolor{stringliteral}{"{}junction\_name"{}}];}
\DoxyCodeLine{106     \textcolor{keyword}{auto} \textcolor{keyword}{const} \&outlet\_vessels = junction\_config[\textcolor{stringliteral}{"{}outlet\_vessels"{}}];}
\DoxyCodeLine{107     \textcolor{keywordtype}{int} num\_outlets = outlet\_vessels.size();}
\DoxyCodeLine{108     \textcolor{keywordflow}{if} (num\_outlets == 1) \{}
\DoxyCodeLine{109       model.add\_block(MODEL::BlockType::JUNCTION, \{\}, junction\_name);}
\DoxyCodeLine{110     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{111       std::vector<int> param\_ids;}
\DoxyCodeLine{112       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < (num\_outlets * (num\_params -\/ 1)); i++)}
\DoxyCodeLine{113         param\_ids.push\_back(param\_counter++);}
\DoxyCodeLine{114       model.add\_block(MODEL::BlockType::BLOODVESSELJUNCTION, param\_ids,}
\DoxyCodeLine{115                       junction\_name);}
\DoxyCodeLine{116     \}}
\DoxyCodeLine{117     \textcolor{comment}{// Check for connections to inlet and outlet vessels and append to}}
\DoxyCodeLine{118     \textcolor{comment}{// connections list}}
\DoxyCodeLine{119     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} vessel\_id : junction\_config[\textcolor{stringliteral}{"{}inlet\_vessels"{}}])}
\DoxyCodeLine{120       connections.push\_back(\{vessel\_id\_map[vessel\_id], junction\_name\});}
\DoxyCodeLine{121     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} vessel\_id : outlet\_vessels)}
\DoxyCodeLine{122       connections.push\_back(\{junction\_name, vessel\_id\_map[vessel\_id]\});}
\DoxyCodeLine{123     DEBUG\_MSG(\textcolor{stringliteral}{"{}Created junction "{}} << junction\_name);}
\DoxyCodeLine{124   \}}
\DoxyCodeLine{125 }
\DoxyCodeLine{126   \textcolor{comment}{// Create Connections}}
\DoxyCodeLine{127   DEBUG\_MSG(\textcolor{stringliteral}{"{}Created connection"{}});}
\DoxyCodeLine{128   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&connection : connections) \{}
\DoxyCodeLine{129     \textcolor{keyword}{auto} ele1 = model.get\_block(std::get<0>(connection));}
\DoxyCodeLine{130     \textcolor{keyword}{auto} ele2 = model.get\_block(std::get<1>(connection));}
\DoxyCodeLine{131     model.add\_node(\{ele1\}, \{ele2\}, ele1-\/>get\_name() + \textcolor{stringliteral}{"{}:"{}} + ele2-\/>get\_name());}
\DoxyCodeLine{132   \}}
\DoxyCodeLine{133   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&connection : inlet\_connections) \{}
\DoxyCodeLine{134     \textcolor{keyword}{auto} ele = model.get\_block(std::get<1>(connection));}
\DoxyCodeLine{135     model.add\_node(\{\}, \{ele\}, std::get<0>(connection) + \textcolor{stringliteral}{"{}:"{}} + ele-\/>get\_name());}
\DoxyCodeLine{136   \}}
\DoxyCodeLine{137   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&connection : outlet\_connections) \{}
\DoxyCodeLine{138     \textcolor{keyword}{auto} ele = model.get\_block(std::get<0>(connection));}
\DoxyCodeLine{139     model.add\_node(\{ele\}, \{\}, ele-\/>get\_name() + \textcolor{stringliteral}{"{}:"{}} + std::get<1>(connection));}
\DoxyCodeLine{140   \}}
\DoxyCodeLine{141 }
\DoxyCodeLine{142   \textcolor{comment}{// Finalize model}}
\DoxyCodeLine{143   model.finalize();}
\DoxyCodeLine{144 }
\DoxyCodeLine{145   DEBUG\_MSG(\textcolor{stringliteral}{"{}Number of parameters "{}} << param\_counter);}
\DoxyCodeLine{146 }
\DoxyCodeLine{147   \textcolor{comment}{// Read observations}}
\DoxyCodeLine{148   DEBUG\_MSG(\textcolor{stringliteral}{"{}Reading observations"{}});}
\DoxyCodeLine{149   \textcolor{keywordtype}{int} num\_obs = 0;}
\DoxyCodeLine{150   std::vector<std::vector<T>> y\_all;}
\DoxyCodeLine{151   std::vector<std::vector<T>> dy\_all;}
\DoxyCodeLine{152   \textcolor{keyword}{auto} y\_values = config[\textcolor{stringliteral}{"{}y"{}}];}
\DoxyCodeLine{153   \textcolor{keyword}{auto} dy\_values = config[\textcolor{stringliteral}{"{}dy"{}}];}
\DoxyCodeLine{154   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < model.dofhandler.get\_num\_variables(); i++) \{}
\DoxyCodeLine{155     std::string var\_name = model.dofhandler.variables[i];}
\DoxyCodeLine{156     DEBUG\_MSG(\textcolor{stringliteral}{"{}Reading observations for variable "{}} << var\_name);}
\DoxyCodeLine{157     \textcolor{keywordflow}{if} (!y\_values.contains(var\_name)) \{}
\DoxyCodeLine{158       std::cout << \textcolor{stringliteral}{"{}ERROR: Missing y observation for '"{}} << var\_name << \textcolor{stringliteral}{"{}'"{}}}
\DoxyCodeLine{159                 << std::endl;}
\DoxyCodeLine{160       exit(1);}
\DoxyCodeLine{161     \}}
\DoxyCodeLine{162     \textcolor{keywordflow}{if} (!dy\_values.contains(var\_name)) \{}
\DoxyCodeLine{163       std::cout << \textcolor{stringliteral}{"{}ERROR: Missing dy observation for '"{}} << var\_name << \textcolor{stringliteral}{"{}'"{}}}
\DoxyCodeLine{164                 << std::endl;}
\DoxyCodeLine{165       exit(1);}
\DoxyCodeLine{166     \}}
\DoxyCodeLine{167     \textcolor{keyword}{auto} y\_array = y\_values[var\_name].get<std::vector<T>>();}
\DoxyCodeLine{168     \textcolor{keyword}{auto} dy\_array = dy\_values[var\_name].get<std::vector<T>>();}
\DoxyCodeLine{169     num\_obs = y\_array.size();}
\DoxyCodeLine{170     \textcolor{keywordflow}{if} (i == 0) \{}
\DoxyCodeLine{171       y\_all.resize(num\_obs);}
\DoxyCodeLine{172       dy\_all.resize(num\_obs);}
\DoxyCodeLine{173     \}}
\DoxyCodeLine{174     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} j = 0; j < num\_obs; j++) \{}
\DoxyCodeLine{175       y\_all[j].push\_back(y\_array[j]);}
\DoxyCodeLine{176       dy\_all[j].push\_back(dy\_array[j]);}
\DoxyCodeLine{177     \}}
\DoxyCodeLine{178   \}}
\DoxyCodeLine{179   DEBUG\_MSG(\textcolor{stringliteral}{"{}Number of observations: "{}} << num\_obs);}
\DoxyCodeLine{180 }
\DoxyCodeLine{181   \textcolor{comment}{// Setup start parameter vector}}
\DoxyCodeLine{182   Eigen::Matrix<T, Eigen::Dynamic, 1> alpha =}
\DoxyCodeLine{183       Eigen::Matrix<T, Eigen::Dynamic, 1>::Zero(param\_counter);}
\DoxyCodeLine{184   DEBUG\_MSG(\textcolor{stringliteral}{"{}Reading initial alpha"{}});}
\DoxyCodeLine{185   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&vessel\_config : output\_config[\textcolor{stringliteral}{"{}vessels"{}}]) \{}
\DoxyCodeLine{186     std::string vessel\_name = vessel\_config[\textcolor{stringliteral}{"{}vessel\_name"{}}];}
\DoxyCodeLine{187     DEBUG\_MSG(\textcolor{stringliteral}{"{}Reading initial alpha for "{}} << vessel\_name);}
\DoxyCodeLine{188     \textcolor{keyword}{auto} block = model.get\_block(vessel\_name);}
\DoxyCodeLine{189     alpha[block-\/>global\_param\_ids[0]] =}
\DoxyCodeLine{190         vessel\_config[\textcolor{stringliteral}{"{}zero\_d\_element\_values"{}}].value(\textcolor{stringliteral}{"{}R\_poiseuille"{}}, 0.0);}
\DoxyCodeLine{191     alpha[block-\/>global\_param\_ids[1]] =}
\DoxyCodeLine{192         vessel\_config[\textcolor{stringliteral}{"{}zero\_d\_element\_values"{}}].value(\textcolor{stringliteral}{"{}C"{}}, 0.0);}
\DoxyCodeLine{193     alpha[block-\/>global\_param\_ids[2]] =}
\DoxyCodeLine{194         vessel\_config[\textcolor{stringliteral}{"{}zero\_d\_element\_values"{}}].value(\textcolor{stringliteral}{"{}L"{}}, 0.0);}
\DoxyCodeLine{195     \textcolor{keywordflow}{if} (num\_params > 3) \{}
\DoxyCodeLine{196       alpha[block-\/>global\_param\_ids[3]] =}
\DoxyCodeLine{197           vessel\_config[\textcolor{stringliteral}{"{}zero\_d\_element\_values"{}}].value(\textcolor{stringliteral}{"{}stenosis\_coefficient"{}},}
\DoxyCodeLine{198                                                        0.0);}
\DoxyCodeLine{199     \}}
\DoxyCodeLine{200   \}}
\DoxyCodeLine{201   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&junction\_config : output\_config[\textcolor{stringliteral}{"{}junctions"{}}]) \{}
\DoxyCodeLine{202     std::string junction\_name = junction\_config[\textcolor{stringliteral}{"{}junction\_name"{}}];}
\DoxyCodeLine{203     DEBUG\_MSG(\textcolor{stringliteral}{"{}Reading initial alpha for "{}} << junction\_name);}
\DoxyCodeLine{204     \textcolor{keyword}{auto} block = model.get\_block(junction\_name);}
\DoxyCodeLine{205     \textcolor{keywordtype}{int} num\_outlets = block-\/>outlet\_nodes.size();}
\DoxyCodeLine{206 }
\DoxyCodeLine{207     \textcolor{keywordflow}{if} (num\_outlets < 2) \{}
\DoxyCodeLine{208       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{209     \}}
\DoxyCodeLine{210 }
\DoxyCodeLine{211     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_outlets; i++) \{}
\DoxyCodeLine{212       alpha[block-\/>global\_param\_ids[i]] = 0.0;}
\DoxyCodeLine{213       alpha[block-\/>global\_param\_ids[i + num\_outlets]] = 0.0;}
\DoxyCodeLine{214       \textcolor{keywordflow}{if} (num\_params > 3) \{}
\DoxyCodeLine{215         alpha[block-\/>global\_param\_ids[i + 2 * num\_outlets]] = 0.0;}
\DoxyCodeLine{216       \}}
\DoxyCodeLine{217     \}}
\DoxyCodeLine{218     \textcolor{keywordflow}{if} (junction\_config[\textcolor{stringliteral}{"{}junction\_type"{}}] == \textcolor{stringliteral}{"{}BloodVesselJunction"{}}) \{}
\DoxyCodeLine{219       \textcolor{keyword}{auto} resistance = junction\_config[\textcolor{stringliteral}{"{}junction\_values"{}}][\textcolor{stringliteral}{"{}R\_poiseuille"{}}]}
\DoxyCodeLine{220                             .get<std::vector<T>>();}
\DoxyCodeLine{221       \textcolor{keyword}{auto} inductance =}
\DoxyCodeLine{222           junction\_config[\textcolor{stringliteral}{"{}junction\_values"{}}][\textcolor{stringliteral}{"{}L"{}}].get<std::vector<T>>();}
\DoxyCodeLine{223       \textcolor{keyword}{auto} stenosis\_coeff =}
\DoxyCodeLine{224           junction\_config[\textcolor{stringliteral}{"{}junction\_values"{}}][\textcolor{stringliteral}{"{}stenosis\_coefficient"{}}]}
\DoxyCodeLine{225               .get<std::vector<T>>();}
\DoxyCodeLine{226       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_outlets; i++) \{}
\DoxyCodeLine{227         alpha[block-\/>global\_param\_ids[i]] = resistance[i];}
\DoxyCodeLine{228         alpha[block-\/>global\_param\_ids[i + num\_outlets]] = inductance[i];}
\DoxyCodeLine{229         \textcolor{keywordflow}{if} (num\_params > 3) \{}
\DoxyCodeLine{230           alpha[block-\/>global\_param\_ids[i + 2 * num\_outlets]] =}
\DoxyCodeLine{231               stenosis\_coeff[i];}
\DoxyCodeLine{232         \}}
\DoxyCodeLine{233       \}}
\DoxyCodeLine{234     \}}
\DoxyCodeLine{235   \}}
\DoxyCodeLine{236 }
\DoxyCodeLine{237   \textcolor{comment}{// Run optimization}}
\DoxyCodeLine{238   DEBUG\_MSG(\textcolor{stringliteral}{"{}Start optimization"{}});}
\DoxyCodeLine{239   \textcolor{keyword}{auto} lm\_alg =}
\DoxyCodeLine{240       \mbox{\hyperlink{class_o_p_t_1_1_levenberg_marquardt_optimizer}{OPT::LevenbergMarquardtOptimizer}}(\&model, num\_obs, param\_counter, lambda0,}
\DoxyCodeLine{241                                        gradient\_tol, increment\_tol, max\_iter);}
\DoxyCodeLine{242 }
\DoxyCodeLine{243   alpha = lm\_alg.run(alpha, y\_all, dy\_all);}
\DoxyCodeLine{244 }
\DoxyCodeLine{245   \textcolor{comment}{// Write optimized simulation config file}}
\DoxyCodeLine{246   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&vessel\_config : output\_config[\textcolor{stringliteral}{"{}vessels"{}}]) \{}
\DoxyCodeLine{247     std::string vessel\_name = vessel\_config[\textcolor{stringliteral}{"{}vessel\_name"{}}];}
\DoxyCodeLine{248     \textcolor{keyword}{auto} block = model.get\_block(vessel\_name);}
\DoxyCodeLine{249     T stenosis\_coeff = 0.0;}
\DoxyCodeLine{250     \textcolor{keywordflow}{if} (num\_params > 3) \{}
\DoxyCodeLine{251       stenosis\_coeff = alpha[block-\/>global\_param\_ids[3]];}
\DoxyCodeLine{252     \}}
\DoxyCodeLine{253     T c\_value = 0.0;}
\DoxyCodeLine{254     \textcolor{keywordflow}{if} (!zero\_capacitance) \{}
\DoxyCodeLine{255       c\_value = alpha[block-\/>global\_param\_ids[1]];}
\DoxyCodeLine{256     \}}
\DoxyCodeLine{257     vessel\_config[\textcolor{stringliteral}{"{}zero\_d\_element\_values"{}}] = \{}
\DoxyCodeLine{258         \{\textcolor{stringliteral}{"{}R\_poiseuille"{}}, alpha[block-\/>global\_param\_ids[0]]\},}
\DoxyCodeLine{259         \{\textcolor{stringliteral}{"{}C"{}}, std::max(c\_value, 0.0)\},}
\DoxyCodeLine{260         \{\textcolor{stringliteral}{"{}L"{}}, std::max(alpha[block-\/>global\_param\_ids[2]], 0.0)\},}
\DoxyCodeLine{261         \{\textcolor{stringliteral}{"{}stenosis\_coefficient"{}}, stenosis\_coeff\}\};}
\DoxyCodeLine{262   \}}
\DoxyCodeLine{263   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} \&junction\_config : output\_config[\textcolor{stringliteral}{"{}junctions"{}}]) \{}
\DoxyCodeLine{264     std::string junction\_name = junction\_config[\textcolor{stringliteral}{"{}junction\_name"{}}];}
\DoxyCodeLine{265     \textcolor{keyword}{auto} block = model.get\_block(junction\_name);}
\DoxyCodeLine{266     \textcolor{keywordtype}{int} num\_outlets = block-\/>outlet\_nodes.size();}
\DoxyCodeLine{267 }
\DoxyCodeLine{268     \textcolor{keywordflow}{if} (num\_outlets < 2) \{}
\DoxyCodeLine{269       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{270     \}}
\DoxyCodeLine{271 }
\DoxyCodeLine{272     std::vector<T> r\_values;}
\DoxyCodeLine{273     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_outlets; i++) \{}
\DoxyCodeLine{274       r\_values.push\_back(alpha[block-\/>global\_param\_ids[i]]);}
\DoxyCodeLine{275     \}}
\DoxyCodeLine{276     std::vector<T> l\_values;}
\DoxyCodeLine{277     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_outlets; i++) \{}
\DoxyCodeLine{278       l\_values.push\_back(}
\DoxyCodeLine{279           std::max(alpha[block-\/>global\_param\_ids[i + num\_outlets]], 0.0));}
\DoxyCodeLine{280     \}}
\DoxyCodeLine{281     std::vector<T> ste\_values;}
\DoxyCodeLine{282     \textcolor{keywordflow}{if} (num\_params > 3) \{}
\DoxyCodeLine{283       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_outlets; i++) \{}
\DoxyCodeLine{284         ste\_values.push\_back(}
\DoxyCodeLine{285             alpha[block-\/>global\_param\_ids[i + 2 * num\_outlets]]);}
\DoxyCodeLine{286       \}}
\DoxyCodeLine{287     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{288       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_outlets; i++) \{}
\DoxyCodeLine{289         ste\_values.push\_back(0.0);}
\DoxyCodeLine{290       \}}
\DoxyCodeLine{291     \}}
\DoxyCodeLine{292     junction\_config[\textcolor{stringliteral}{"{}junction\_type"{}}] = \textcolor{stringliteral}{"{}BloodVesselJunction"{}};}
\DoxyCodeLine{293     junction\_config[\textcolor{stringliteral}{"{}junction\_values"{}}] = \{\{\textcolor{stringliteral}{"{}R\_poiseuille"{}}, r\_values\},}
\DoxyCodeLine{294                                           \{\textcolor{stringliteral}{"{}L"{}}, l\_values\},}
\DoxyCodeLine{295                                           \{\textcolor{stringliteral}{"{}stenosis\_coefficient"{}}, ste\_values\}\};}
\DoxyCodeLine{296   \}}
\DoxyCodeLine{297 }
\DoxyCodeLine{298   output\_config.erase(\textcolor{stringliteral}{"{}y"{}});}
\DoxyCodeLine{299   output\_config.erase(\textcolor{stringliteral}{"{}dy"{}});}
\DoxyCodeLine{300   output\_config.erase(\textcolor{stringliteral}{"{}calibration\_parameters"{}});}
\DoxyCodeLine{301 }
\DoxyCodeLine{302   \textcolor{keywordflow}{return} output\_config;}
\DoxyCodeLine{303 \}}
\DoxyCodeLine{304 }
\DoxyCodeLine{305 \}  \textcolor{comment}{// namespace OPT}}
\DoxyCodeLine{306 }
\DoxyCodeLine{307 \textcolor{preprocessor}{\#endif  }\textcolor{comment}{// SVZERODSOLVER\_OPTIMIZE\_CALIBRATOR\_HPP\_}}

\end{DoxyCode}
